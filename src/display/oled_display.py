import machine
import network
import time
import framebuf
from ssd1306 import SSD1306_I2C

class OLEDDisplay:
    def __init__(self, sda_pin=21, scl_pin=22, width=128, height=64):
        self.i2c = machine.I2C(0, sda=machine.Pin(sda_pin), scl=machine.Pin(scl_pin))
        self.display = SSD1306_I2C(width, height, self.i2c)
        self.width = width
        self.height = height
                
        # Icona WiFi
        self.WIFI_ICON = bytearray([
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x3f, 0xc0, 0x00, 0x00, 0xe0, 0x70, 0x00, 0x01, 0x8f, 0x18, 0x00, 
            0x00, 0x3f, 0xc0, 0x00, 0x00, 0x60, 0x60, 0x00, 0x00, 0x0f, 0x00, 0x00, 0x00, 0x1f, 0x80, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
        ])
        
        # Icona CLOUD
        self.CLOUD_ICON = bytearray([
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0xf8, 0x00, 0x00, 0x00, 0x01, 0xdc, 0x00, 0x00, 0x00, 0x03, 0x06, 0x00, 
            0x00, 0x00, 0x3e, 0x03, 0x00, 0x00, 0x00, 0x64, 0x01, 0x00, 0x00, 0x00, 0x40, 0x01, 0x00, 0x00, 
            0x01, 0xc0, 0x01, 0xc0, 0x00, 0x01, 0x00, 0x00, 0x60, 0x00, 0x03, 0x00, 0x00, 0x20, 0x00, 0x02, 
            0x00, 0x00, 0x10, 0x00, 0x02, 0x00, 0x00, 0x10, 0x00, 0x01, 0x00, 0x00, 0x20, 0x00, 0x01, 0xc0, 
            0x00, 0xe0, 0x00, 0x00, 0x7f, 0xff, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
        ])

        # Icona REFRESH  
        self.REFRESH_ICON = bytearray([
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x01, 0x80, 0x00, 0x7f, 0x80, 0x01, 0xff, 0x80, 0x01, 0x87, 0x80, 0x03, 0x06, 0x00, 0x02, 0x00, 
            0x40, 0x06, 0x00, 0x60, 0x06, 0x00, 0x60, 0x06, 0x00, 0x60, 0x02, 0x00, 0x40, 0x03, 0x00, 0xc0, 
            0x03, 0x81, 0xc0, 0x01, 0xe7, 0x80, 0x00, 0x7e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00])
        
        # Icona ALERT
        self.ALERT_ICON_LARGE = bytearray([0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x80, 0x00, 0x00, 0x00, 0x00, 
            0x03, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x06, 0x60, 0x00, 0x00, 0x00, 0x00, 0x06, 0x60, 0x00, 0x00, 
            0x00, 0x00, 0x0c, 0x30, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 
            0x00, 0x00, 0x00, 0x00, 0x30, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x31, 0x8c, 0x00, 0x00, 0x00, 0x00, 
            0x61, 0x86, 0x00, 0x00, 0x00, 0x00, 0x61, 0x86, 0x00, 0x00, 0x00, 0x00, 0xc1, 0x83, 0x00, 0x00, 
            0x00, 0x01, 0x81, 0x81, 0x80, 0x00, 0x00, 0x01, 0x81, 0x81, 0x80, 0x00, 0x00, 0x03, 0x01, 0x80, 
            0xc0, 0x00, 0x00, 0x03, 0x00, 0x00, 0xc0, 0x00, 0x00, 0x06, 0x00, 0x00, 0x60, 0x00, 0x00, 0x04, 
            0x01, 0x80, 0x20, 0x00, 0x00, 0x0c, 0x01, 0x80, 0x30, 0x00, 0x00, 0x18, 0x01, 0x80, 0x18, 0x00, 
            0x00, 0x18, 0x00, 0x00, 0x18, 0x00, 0x00, 0x18, 0x00, 0x00, 0x18, 0x00, 0x00, 0x1f, 0xff, 0xff, 
            0xf8, 0x00, 0x00, 0x0f, 0xff, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00])

        #Logo NextGarage
        self.logo_data = bytearray([0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc7, 0xf3, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x93, 0xf3, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf7, 0x9b, 0xe3, 0xf7, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc7, 0x9f, 0xe3, 0xe1, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x8f, 0x9f, 0xcb, 0xed, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe7, 0xd9, 0xcb, 0xcd, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf7, 0xd9, 0xdb, 0xd9, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0xfb, 0xf3, 0xcd, 0xd3, 0x99, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0xf9, 0xf3, 0xcd, 0x83, 0x83, 0xf3, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0xc9, 0xf9, 0xe9, 0xbb, 0x2f, 0xe3, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0xe1, 0xfd, 0xe3, 0xfb, 0x6f, 0xc3, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0xfc, 0xff, 0xff, 0x6f, 0x27, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x3e, 0xff, 0xff, 0xee, 0x6f, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xfe, 0xfe, 0x0f, 0xff, 0xff, 0xf8, 0x4f, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xfc, 0xfe, 0x6f, 0xff, 0xff, 0xf9, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xfc, 0xff, 0x7f, 0xff, 0xff, 0xff, 0x3e, 0x1f, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xfc, 0x5f, 0x3f, 0xff, 0xff, 0xff, 0x38, 0x6f, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0x1f, 0xff, 0xff, 0xff, 0xff, 0x71, 0xef, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0xc6, 0xff, 0xff, 0xff, 0xff, 0xe7, 0xcf, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0xe1, 0xff, 0xff, 0xff, 0xfc, 0xce, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0xf9, 0xff, 0xff, 0xff, 0xf9, 0x5c, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xe1, 0xff, 0xff, 0x00, 0x00, 0x03, 0x61, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xfc, 0x1f, 0xfe, 0xff, 0xff, 0xfc, 0x77, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0x87, 0xfd, 0xff, 0xff, 0xff, 0xff, 0xe1, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xc0, 0x1f, 0xf9, 0xff, 0xff, 0xff, 0xfe, 0x01, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xc1, 0xff, 0xfb, 0xff, 0xff, 0xff, 0xf0, 0x1d, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xfc, 0x1f, 0x13, 0xff, 0xff, 0xff, 0xf3, 0xdd, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0xcf, 0x07, 0xff, 0xff, 0xff, 0xfb, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc7, 0xff, 0xff, 0x9f, 0xfb, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x80, 0x00, 0x00, 0x6f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x80, 0x00, 0xff, 0x6f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x30, 0x00, 0xff, 0x9f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x3c, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x3e, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x1e, 0x7f, 0xff, 0xf8, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x03, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0xff, 0xf8, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0xff, 0x9f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0xff, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x6f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x01, 0xff, 0xff, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
            0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff])

    def clear(self):
        self.display.fill(0)
        
    def text(self, text, x, y):
        self.display.text(text, x, y)
        
    def show(self):
        self.display.show()
        
    def show_logo(self, duration=3):
        self.clear()
        try:
            fb = framebuf.FrameBuffer(self.logo_data, 128, 64, framebuf.MONO_HLSB)
            self.display.blit(fb, 0, 0)
        except Exception:
            self.display.text("NEXTGARAGE", 25, 20)
        self.show()
        time.sleep(duration)

    def show_wifi_connecting(self):
        self.clear()
        fb_icon = framebuf.FrameBuffer(self.WIFI_ICON, 28, 28, framebuf.MONO_HLSB)
        self.display.blit(fb_icon, 52, 10)
        self.display.text("Connessione...", 10, 40) 
        self.show()

    def show_mqtt_connecting(self):
        self.clear()
        fb_icon = framebuf.FrameBuffer(self.CLOUD_ICON, 34, 34, framebuf.MONO_HLSB)
        self.display.blit(fb_icon, 48, 5)
        self.display.text("Connessione", 20, 35)
        self.display.text("Cloud MQTT...", 15, 48)
        self.show()

    def show_system_reset(self):
        self.clear()
        fb_icon = framebuf.FrameBuffer(self.REFRESH_ICON, 24, 24, framebuf.MONO_HLSB)
        self.display.blit(fb_icon, 52, 10)
        self.display.text("RIAVVIO SISTEMA", 5, 40)
        self.display.rect(14, 55, 100, 6, 1)
        self.display.fill_rect(16, 57, 96, 2, 1)
        self.show()

    def show_main_screen(self, gate_status, parking_status, gas_level, alarm_active=False, distance=None, lux_level=None):
        self.clear()
        self.display.text("NextGarage", 25, 0)
        self.display.hline(0, 10, 128, 1)
        
        y = 12
        x_label = 0
        x_val = 55
        
        self.display.text("Sbarra:", x_label, y)
        gate_text = "APERTA" if gate_status else "CHIUSA"
        self.display.text(gate_text, x_val, y)
        y += 10
        
        self.display.text("Posto:", x_label, y)
        park_text = "OCCUPATO" if parking_status else "LIBERO"
        self.display.text(park_text, x_val, y)
        y += 10
        
        if distance is not None and distance > 0:
            self.display.text("Dist:", x_label, y)
            self.display.text(f"{distance:.1f}cm", x_val, y)
            y += 10
        
        if alarm_active:
            self.display.text("GAS:", x_label, y)
            self.display.text("ALLARME!", x_val, y)
        else:
            self.display.text("Gas:", x_label, y)
            self.display.text(f"{gas_level} raw", x_val, y)
        y += 10
        
        if lux_level is not None:
            self.display.text("Luce:", x_label, y)
            self.display.text(f"{lux_level:.0f} lx", x_val, y)
        
        self.display.hline(0, 54, 128, 1)
        status = "Sistema Online" if self._is_wifi_connected() else "Sistema Offline"
        self.display.text(status, 10, 56)
        self.show()

    def show_parking_assist(self, distance):
        self.clear()
        self.display.text("PARCHEGGIO", 25, 0)
        self.display.hline(0, 10, 128, 1)
        
        bar_x = 10
        bar_y = 25
        bar_w_total = 108
        bar_h = 12
        
        self.display.rect(bar_x, bar_y, bar_w_total, bar_h, 1)
        
        max_dist = 7.0 
        target_dist = 3.0
        clamped_dist = max(0, min(distance, max_dist))
        
        fill_percent = 1.0 - (clamped_dist / max_dist)
        fill_width = int(bar_w_total * fill_percent)
        
        if fill_width > 0:
            self.display.fill_rect(bar_x, bar_y, fill_width, bar_h, 1)
            
        ratio = 1.0 - (target_dist / max_dist)
        target_x = bar_x + int(bar_w_total * ratio)
        self.display.vline(target_x, bar_y-2, bar_h+4, 1) 
        
        dist_str = f"{distance:.1f} cm"
        x_text = 64 - (len(dist_str) * 4)
        self.display.text(dist_str, x_text, 45)
        
        if distance <= 3.2: 
            self.display.text("STOP", 50, 56)
        elif distance < 5.0:
            self.display.text("Rallentare", 30, 56)
        else:
            self.display.text("Avanti", 50, 56)
        self.show()

    def show_gas_alarm(self, gas_level):
        self.clear()
        fb_icon = framebuf.FrameBuffer(self.ALERT_ICON_LARGE, 48, 48, framebuf.MONO_HLSB)
        self.display.blit(fb_icon, 40, 0) 
        self.display.text("PERICOLO GAS", 15, 54)
        self.show()

    def show_error(self, error_msg):
        self.clear()
        self.display.text("ERRORE", 40, 0)
        self.display.hline(0, 10, 128, 1)
        self.display.text(error_msg, 0, 25)
        self.show()
    
    def _is_wifi_connected(self):
        """Ritorna True se la STA WiFi Ã¨ connessa."""
        try:
            wlan = network.WLAN(network.STA_IF)
            return wlan.active() and wlan.isconnected()
        except:
            return False